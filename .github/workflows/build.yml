name: Build and Create Pre-release

on:
  push:
    branches:
      - master
      - dev
  pull_request:
    branches:
      - master
      - dev
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.5'
    
    - name: Make gradlew executable
      run: chmod +x gradlew
    
    - name: Clean previous builds
      run: |
        rm -f build/*.jar 2>/dev/null || true
        rm -f *.jar 2>/dev/null || true
    
    - name: Build with Gradle
      run: ./gradlew iris
      env:
        GRADLE_OPTS: -Dorg.gradle.daemon=false
    
    - name: Get Git version info
      id: version
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
        
        echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_OUTPUT
        echo "BRANCH=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_OUTPUT
        echo "VERSION=$SHORT_SHA" >> $GITHUB_OUTPUT
    
    - name: Find and rename JAR file
      id: find_jar
      run: |
        # 1. 查找原始的 JAR 文件
        echo "Searching for JAR files..."
        
        # 检查常见的构建输出目录
        ORIGINAL_JAR=""
        
        if [ -f "build/libs/Iris.jar" ]; then
          ORIGINAL_JAR="build/libs/Iris.jar"
        elif [ -f "build/Iris.jar" ]; then
          ORIGINAL_JAR="build/Iris.jar"
        else
          # 查找 Iris-*.jar 文件（但不包含哈希的）
          ORIGINAL_JAR=$(find build -name "Iris-*.jar" -type f ! -name "*-*.jar" | head -1)
          if [ -z "$ORIGINAL_JAR" ]; then
            # 查找任何 Iris*.jar
            ORIGINAL_JAR=$(find build -name "Iris*.jar" -type f ! -name "*${{ steps.version.outputs.SHORT_SHA }}*" | head -1)
          fi
        fi
        
        if [ -z "$ORIGINAL_JAR" ]; then
          echo "Error: No JAR file found!"
          find build -name "*.jar" -type f 2>/dev/null || echo "No JAR files found"
          exit 1
        fi
        
        echo "Original JAR found: $ORIGINAL_JAR"
        
        # 2. 提取基础名称（去掉 .jar 扩展名）
        ORIGINAL_NAME=$(basename "$ORIGINAL_JAR" .jar)
        echo "Original name: $ORIGINAL_NAME"
        
        # 3. 检查是否已经包含哈希值
        if [[ "$ORIGINAL_NAME" == *"-${{ steps.version.outputs.SHORT_SHA }}" ]]; then
          # 如果已经包含哈希值，直接使用
          FINAL_NAME="$ORIGINAL_NAME.jar"
          FINAL_PATH="$ORIGINAL_JAR"
          echo "JAR already has hash in name"
        else
          # 4. 构建新的文件名：基础名称 + 哈希
          FINAL_NAME="${ORIGINAL_NAME}-${{ steps.version.outputs.SHORT_SHA }}.jar"
          FINAL_PATH="build/$FINAL_NAME"
          
          # 5. 复制并重命名，删除原文件
          cp "$ORIGINAL_JAR" "$FINAL_PATH"
          echo "Renamed to: $FINAL_NAME"
        fi
        
        # 6. 清理其他可能的重复文件
        echo "Cleaning up duplicate files..."
        
        # 删除没有哈希的文件
        find build -name "Iris.jar" -type f -delete 2>/dev/null || true
        find build -name "Iris-*.jar" -type f ! -name "*-${{ steps.version.outputs.SHORT_SHA }}.jar" -delete 2>/dev/null || true
        find build -name "iris-*.jar" -type f ! -name "*${{ steps.version.outputs.SHORT_SHA }}*" -delete 2>/dev/null || true
        
        # 7. 确保只有一个文件存在
        echo "Remaining JAR files:"
        find build -name "*.jar" -type f 2>/dev/null || echo "No JAR files"
        
        # 8. 设置输出
        echo "FINAL_PATH=$FINAL_PATH" >> $GITHUB_OUTPUT
        echo "FINAL_NAME=$FINAL_NAME" >> $GITHUB_OUTPUT
    
    - name: Verify single JAR file
      run: |
        echo "Verifying JAR files..."
        JAR_COUNT=$(find build -name "*.jar" -type f 2>/dev/null | wc -l)
        echo "Found $JAR_COUNT JAR file(s)"
        
        if [ $JAR_COUNT -eq 0 ]; then
          echo "Error: No JAR file found!"
          exit 1
        elif [ $JAR_COUNT -gt 1 ]; then
          echo "Warning: Multiple JAR files found:"
          find build -name "*.jar" -type f
          echo "Keeping only the one with hash..."
          # 只保留带哈希的文件
          find build -name "*.jar" -type f ! -name "*${{ steps.version.outputs.SHORT_SHA }}*" -delete 2>/dev/null || true
          echo "After cleanup:"
          find build -name "*.jar" -type f 2>/dev/null || echo "No JAR files"
        fi
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: iris-${{ steps.version.outputs.SHORT_SHA }}
        path: |
          build/*.jar
        retention-days: 7
        if-no-files-found: error
    
    - name: Create Pre-release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/dev')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: pre-${{ steps.version.outputs.VERSION }}
        name: "Pre-release ${{ steps.version.outputs.VERSION }} (${{ steps.version.outputs.BRANCH }})"
        body: |
          ## 自动构建的预发布版本
          
          **版本:** ${{ steps.version.outputs.VERSION }}
          **分支:** ${{ steps.version.outputs.BRANCH }}
          **构建时间:** ${{ steps.version.outputs.TIMESTAMP }}
          **提交:** ${{ github.sha }}
          
          ### 下载
          文件: [${{ steps.find_jar.outputs.FINAL_NAME }}](${{ steps.find_jar.outputs.FINAL_NAME }})
          
          ### 提交信息
          ```text
          ${{ github.event.head_commit.message }}
          ```
        draft: false
        prerelease: true
        files: |
          ${{ steps.find_jar.outputs.FINAL_PATH }}
        generate_release_notes: false
